<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Monday, April 12, 2021, 3:48 PM -->
<!-- MuClient version 5.05 -->

<!-- Plugin "Secretpack" generated by Plugin Wizard -->

<muclient>
<plugin
   name="toastush"
   author="Erick Rosso"
   id="843d2f53cb3685465bda7d4a"
   language="Lua"
   date_written="2021-04-12 15:47:28"
   requires="5.05"
   version="2.0"
   save_state="y"
   >
 <description trim="y">

    Welcome to the Miriani MUSHclient soundpack: Toastush.

    To get started with configuring the soundpack, type: `toastush:config'
    To view information about the currently running script type: `toastush:info'
    To update plugins type: `update'


    To view valid starmap filters type: `sm.help'
    To view valid scan filters type: `sc.help'

    To view this help type: `'toastush:help'

    Macros:
    F10: Cycle audio groups.
    Alt+F10: Toggle global mute.
    F11: Decrease group volume.
    F12: Increase group volume.
 
    ** Once in the game, tune a metaf frequency communicator to 0.07 for in game support. **
</description>
</plugin>


<!--  Get our standard constants -->

<include name="constants.lua"/>
<!--  Plugin help  -->
<!-- Triggers -->
<triggers>

  <trigger
 enabled="y"
   script="OnMSP"
   name="MSP"
   match="^(!!SOUND\(.+\))$"
   regexp="y"
   omit_from_output="y"
   send_to="14"
>
  </trigger>

  <trigger
   enabled="y"
   script="OnLink"
   name="http"
   match="((?:https?|ftp|telnet|rsync|mailto|gopher)://[[:graph:]]+[^&quot;])"
   regexp="y"
      send_to="12"
   keep_evaluating="y"
  >
  </trigger>

</triggers>

<aliases>
  <alias
   enabled="y"
   script="help"
   match="^toastush:help$"
   ignore_case="y"
   regexp="y"
  >
  </alias>

  <alias
   enabled="y"
   script="info"
   match="^toastush:info$"
   ignore_case="y"
   regexp="y"
  >
  </alias>

  <alias
   enabled="y"
   script="configure"
   match="^toastush:config(?:ure)?\s?(\w+)?$"
   ignore_case="y"
   regexp="y"
  >
  </alias>

  <alias
   enabled="y"
   script="gen_index"
   match="^toastush:index (.+?)$"
   ignore_case="y"
   regexp="y"
  >
  </alias>

</aliases>

<script>
<![CDATA[
require("json")

relpath = (function()
  local path = require("pl.path")
  return string.gsub(path.relpath(
  GetPluginInfo(GetPluginID(), 20)), 
  "\\", "/").."/"
end)() -- function

require(relpath.."include")

MSP, GMCP = 90, 201 
timeout, link = 120
script = 12
registry = "toastush"


---------------------
-- Macros
AcceleratorTo ("F10", 'cycle_audio_groups()', script) -- cycle sounds
AcceleratorTo("ALT + F10", 'toggle_mute()', script)
AcceleratorTo("F11", 'decrease_attribute("vol")', script)
AcceleratorTo("F12", 'increase_attribute("vol")', script)


---------------------
-- script routines
local options = require(relpath.."options")
function OnPluginInstall()
  assert(config:init_options(options) == 0)

    print("Welcome to the MUSHclient Miriani soundpac: [version: ", VERSION, "] For help see toastush:help.")


  -- janitor code
  janitor()

end -- OnPluginInstall

function OnPluginSaveState()
  config:save()
end -- OnPluginSave

function OnPluginConnect()
  mplay("music/theme")
end -- OnPluginConnect

function OnPluginTelnetRequest (type, data)
  if data == "WILL" then
    if type == GMCP then
      notify("info", "Enabled GMCP")
            return true
    elseif  type == MSP then
      notify("info", "Enabled MSP")
      return true
    end -- if
  end -- if
end -- function OnPluginTelnetRequest

function OnPluginTelnetSubnegotiation (type, data)
   if type == GMCP then
    gmcp_handler(data)
  end -- if
end -- function OnPluginTelnetSubnegotiation

function OnPluginCommandEntered()
   if (not inMenu) and (searchingScan) then
     searchingScan = false
     scan = nil
    classFilter = nil
   end -- if scan
  if inMenu then
    inMenu = false
  end -- if inMenu
end -- OnPluginCommandEnter

function OnPluginBroadcast(event, id, name, text)

  if (id == UPDATE_ID) then
    -- update detected.
    gen_index(event, text, {INDEX})
  end -- if

end -- OnPluginBroadcast


function gmcp_handler(data)

  -- Below follows a typical GMCP implementation.
  -- End users may wish to modify behavior.

  core, params = string.match(data, "([%a.]+)%s+(.*)")
  local info = json.decode(params)

  if core == "communication.channel" then
    Channel(info.channel, info.message, {"channels"})
  elseif core == "communication.say" then
    Channel("say", info.message, {"conversation"})
  elseif core == "communication.tell" then
    Channel("tell", info.message, {"tell"})
  end -- if
end -- gmcp_handler

function OnMSP(name, line, wc)

  local text = wc[1]
  local info = {
  file = string.match(text, "!![%u]+%(([%a%d%p]+).*%)"),
  type = string.match(text, "!![%u]+%(.*T=([%a%d]+).*%)"),
  volume = string.match(text, "!![%u]+%(.*V=([%d]+).*%)"),
  loop = string.match(text, "!![%u]+%(.*L=([%d]+).*%)"),
  continue = string.match(text, "!![%u]+%(.*C=([%d]+).*%)"),
  url = string.match(text, "!![%u]+%(.*U=([%a%d%p]+).*%)")
  }
  msp_handler(info)
end -- OnMSP

function msp_handler(info)

  -- Below follows a typical MSP implementation.
  -- End users may wish to modify behavior.

  play(info.file, info.type)
end -- msp_handler

function on_plugin_update()
  --  Externally called to indicate this plugin should be reloaded upon updates.
  return 1
end -- on_plugin_update

function janitor()

  -- plugins_updater no longer in use.

  local old_plugins = {
  ["fbd5b7cc1ef6acf827a3f4a1"] = "plugins_updater.xml",
  ["55e1d330539761f176fa0815"] = "indexer.xml", 
  } -- old_plugins

  table.foreach(old_plugins,
  function(id, name)
    if (IsPluginInstalled(id)) then
    print("plugin ", name, " is no longer in use. Unloading.")
    UnloadPlugin(id)
    end -- if
  end ) -- foreach

  -- need an index.
  local path = require("pl.path")
  if (not path.isfile(INDEX)) then
    notify("critical", string.format(
    "Warning: You appear to be missing the index file, '%s'. This file is necessary for updates. To generate the file now, type `toastush:index %s'", INDEX, INDEX))
  end -- if

end -- janitor



]]>
</script> 


</muclient>
